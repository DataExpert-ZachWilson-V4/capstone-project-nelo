

# MLB Game Stats Pipeline/Predictor/Chat-Bot




## Overview
This project involves fetching historical & current MLB game stats from MLB.com API. Processing and storing the data in IceBerg tables. Training multiple ML models to predict future game stats of the current season, and storing these predictions back into Iceberg tables. As the days change, the future tables are overwritten daily to update predictions for upcoming games starting from the next day. The future date entries in these tables are shifted forward to the next future date, and the previous future day's data is replaced with the actual game data. Airflow will orchestrate the workflow on a daily schedule. All tables are converted to text embeddings using OpenAI's embeddings and stored in a Qdrant vector store. A RAG model is set up to retrieve the embeddings in Qdrant that match closest to the query embeddings generated by SentenceTransformers and combines into text prompts. These prompts are fed into OpenAI's GPT-3.5-turbo, which generates responses to user queries. The responses from OpenAI GPT are then displayed in the Streamlit app. The responses can also be converted to an audio file using gTTS (Google Text-to-Speech) and played back within the Streamlit app.




## Data Retrieval/Storage Process




## ML Process


## RAG Model/Chat UI Process


# MORE UPDATES WILL BE ADDED DAILY. MY GOAL IS TO HAVE README COMPLETED BY WEEKEND. 


![MLB Diagram](/MLB_Diagram_Update.png)

## Tables

### mlb_db.dim_teamStats
The `dim_teamStats` table stores detailed statistics for each team per game.

| Column                | Type    | Description                                         |
| --------------------- | ------- | --------------------------------------------------- |
| game_id               | STRING  | Unique identifier for each game                     |
| game_date             | STRING  | Date when the game was played                       |
| team_id               | INT     | Unique identifier for the team                      |
| team_name             | STRING  | Name of the team                                    |
| flyOuts               | INT     | Number of fly outs by the team                      |
| groundOuts            | INT     | Number of ground outs by the team                   |
| airOuts               | INT     | Number of air outs by the team                      |
| runs                  | INT     | Number of runs scored by the team                   |
| doubles               | INT     | Number of doubles hit by the team                   |
| triples               | INT     | Number of triples hit by the team                   |
| homeRuns              | INT     | Number of home runs hit by the team                 |
| strikeOuts            | INT     | Number of strikeouts by the team                    |
| baseOnBalls           | INT     | Number of bases on balls (walks) by the team        |
| intentionalWalks      | INT     | Number of intentional walks by the team             |
| hits                  | INT     | Total number of hits by the team                    |
| hitByPitch            | INT     | Number of times team players were hit by a pitch    |
| avg                   | DOUBLE  | Batting average of the team                         |
| atBats                | INT     | Number of at-bats by the team                       |
| obp                   | DOUBLE  | On-base percentage of the team                      |
| slg                   | DOUBLE  | Slugging percentage of the team                     |
| ops                   | DOUBLE  | On-base plus slugging percentage of the team        |
| caughtStealing        | INT     | Number of caught stealing by the team               |
| stolenBases           | INT     | Number of stolen bases by the team                  |
| stolenBasePercentage  | DOUBLE  | Stolen base percentage of the team                  |
| groundIntoDoublePlay  | INT     | Number of ground into double plays by the team      |
| groundIntoTriplePlay  | INT     | Number of ground into triple plays by the team      |
| plateAppearances      | INT     | Number of plate appearances by the team             |
| totalBases            | INT     | Total number of bases earned by the team            |
| rbi                   | INT     | Runs batted in by the team                          |
| leftOnBase            | INT     | Number of players left on base by the team          |
| sacBunts              | INT     | Number of sacrifice bunts by the team               |
| sacFlies              | INT     | Number of sacrifice flies by the team               |
| catchersInterference  | INT     | Number of catcher's interference by the team        |
| pickoffs              | INT     | Number of pickoffs by the team                      |
| atBatsPerHomeRun      | DOUBLE  | Number of at-bats per home run by the team          |
| popOuts               | INT     | Number of pop outs by the team                      |
| lineOuts              | INT     | Number of line outs by the team                     |
| month                 | INT     | Month when the game was played                      |
| day                   | INT     | Day when the game was played                        |
| team_type             | STRING  | Type of team (home or away)                         |

### mlb_db.dim_players
The `dim_players` table stores detailed statistics for each player per game.

| Column                         | Type    | Description                                      |
| ------------------------------ | ------- | ------------------------------------------------ |
| game_id                        | STRING  | Unique identifier for each game                  |
| player_id                      | INT     | Unique identifier for the player                 |
| player_name                    | STRING  | Name of the player                               |
| team_id                        | INT     | Unique identifier for the team                   |
| team_name                      | STRING  | Name of the team                                 |
| batting_order                  | INT     | Batting order position of the player             |
| batting_summary                | STRING  | Summary of batting statistics                    |
| batting_gamesPlayed            | INT     | Number of games played by the player             |
| batting_flyOuts                | INT     | Number of fly outs by the player                 |
| batting_groundOuts             | INT     | Number of ground outs by the player              |
| batting_airOuts                | INT     | Number of air outs by the player                 |
| batting_runs                   | INT     | Number of runs scored by the player              |
| batting_doubles                | INT     | Number of doubles hit by the player              |
| batting_triples                | INT     | Number of triples hit by the player              |
| batting_homeRuns               | INT     | Number of home runs hit by the player            |
| batting_strikeOuts             | INT     | Number of strikeouts by the player               |
| batting_baseOnBalls            | INT     | Number of bases on balls (walks) by the player   |
| batting_intentionalWalks       | INT     | Number of intentional walks by the player        |
| batting_hits                   | INT     | Total number of hits by the player               |
| batting_hitByPitch             | INT     | Number of times player was hit by a pitch        |
| batting_avg                    | DOUBLE  | Batting average of the player                    |
| batting_atBats                 | INT     | Number of at-bats by the player                  |
| batting_obp                    | DOUBLE  | On-base percentage of the player                 |
| batting_slg                    | DOUBLE  | Slugging percentage of the player                |
| batting_ops                    | DOUBLE  | On-base plus slugging percentage of the player   |
| batting_caughtStealing         | INT     | Number of caught stealing by the player          |
| batting_stolenBases            | INT     | Number of stolen bases by the player             |
| batting_stolenBasePercentage   | DOUBLE  | Stolen base percentage of the player             |
| batting_groundIntoDoublePlay   | INT     | Number of ground into double plays by the player |
| batting_groundIntoTriplePlay   | INT     | Number of ground into triple plays by the player |
| batting_plateAppearances       | INT     | Number of plate appearances by the player        |
| batting_totalBases             | INT     | Total number of bases earned by the player       |
| batting_rbi                    | INT     | Runs batted in by the player                     |
| batting_leftOnBase             | INT     | Number of players left on base by the player     |
| batting_sacBunts               | INT     | Number of sacrifice bunts by the player          |
| batting_sacFlies               | INT     | Number of sacrifice flies by the player          |
| batting_catchersInterference   | INT     | Number of catcher's interference by the player   |
| batting_pickoffs               | INT     | Number of pickoffs by the player                 |
| batting_atBatsPerHomeRun       | DOUBLE  | Number of at-bats per home run by the player     |
| batting_popOuts                | INT     | Number of pop outs by the player                 |
| batting_lineOuts               | INT     | Number of line outs by the player                |
| fielding_gamesStarted          | INT     | Number of games started by the player in fielding|
| fielding_caughtStealing        | INT     | Number of caught stealing in fielding by player  |
| fielding_stolenBases           | INT     | Number of stolen bases in fielding by player     |
| fielding_stolenBasePercentage  | DOUBLE  | Stolen base percentage in fielding by player     |
| fielding_assists               | INT     | Number of assists in fielding by player          |
| fielding_putOuts               | INT     | Number of put outs in fielding by player         |
| fielding_errors                | INT     | Number of errors in fielding by player           |
| fielding_chances               | INT     | Number of chances in fielding by player          |
| fielding_fielding              | DOUBLE  | Fielding percentage of the player                |
| fielding_passedBall            | INT     | Number of passed balls by the player             |
| fielding_pickoffs              | INT     | Number of pickoffs in fielding by player         |
| month                          | INT     | Month when the game was played                   |
| day                            | INT     | Day when the game was played                     |
| player_type                    | STRING  | Type of player (home or away)                    |

### mlb_db.aggregated_team_season_totals
The `aggregated_team_season_totals` table stores aggregated season totals for each team.

| Column            | Type    | Description                                         |
| ------------------| ------- | --------------------------------------------------- |
| season            | INT     | The season year                                     |
| team_id           | INT     | Unique identifier for the team                      |
| total_runs        | INT     | Total number of runs scored by the team             |
| total_hits        | INT     | Total number of hits by the team                    |
| total_homeRuns    | INT     | Total number of home runs by the team               |
| total_rbi         | INT     | Total runs batted in by the team                    |
| total_strikeOuts  | INT     | Total number of strikeouts by the team              |
| total_baseOnBalls | INT     | Total number of bases on balls (walks) by the team  |
| total_gamesPlayed | INT     | Total number of games played by the team            |
| month             | INT     | Month when the season was played                    |
| team_type         | STRING  | Type of team (home or away)                         |

### mlb_db.aggregated_players_season_totals
The `aggregated_players_season_totals` table stores aggregated season totals for each player.

| Column            | Type    | Description                                         |
| ------------------| ------- | --------------------------------------------------- |
| season            | INT     | The season year                                     |
| team_id           | INT     | Unique identifier for the team                      |
| player_id         | INT     | Unique identifier for the player                    |
| total_runs        | INT     | Total number of runs scored by the player           |
| total_hits        | INT     | Total number of hits by the player                  |
| total_homeRuns    | INT     | Total number of home runs by the player             |
| total_rbi         | INT     | Total runs batted in by the player                  |
| total_strikeOuts  | INT     | Total number of strikeouts by the player            |
| total_baseOnBalls | INT     | Total number of bases on balls (walks) by the player|
| total_gamesPlayed | INT     | Total number of games played by the player          |
| month             | INT     | Month when the season was played                    |
| player_type       | STRING  | Type of player (home or away)                       |

### mlb_db.aggregated_team_season_averages
The `aggregated_team_season_averages` table stores aggregated season averages for each team.

| Column                | Type    | Description                                         |
| ----------------------| ------- | --------------------------------------------------- |
| season                | INT     | The season year                                     |
| team_id               | INT     | Unique identifier for the team                      |
| avg_runs              | DOUBLE  | Average number of runs scored by the team           |
| avg_hits              | DOUBLE  | Average number of hits by the team                  |
| avg_homeRuns          | DOUBLE  | Average number of home runs by the team             |
| avg_rbi               | DOUBLE  | Average runs batted in by the team                  |
| avg_strikeOuts        | DOUBLE  | Average number of strikeouts by the team            |
| avg_baseOnBalls       | DOUBLE  | Average number of bases on balls (walks) by the team|
| avg_gamesPlayed       | DOUBLE  | Average number of games played by the team          |
| month                 | INT     | Month when the season was played                    |
| team_type             | STRING  | Type of team (home or away)                         |

### mlb_db.aggregated_players_season_averages
The `aggregated_players_season_averages` table stores aggregated season averages for each player.

| Column                | Type    | Description                                         |
| ----------------------| ------- | --------------------------------------------------- |
| season                | INT     | The season year                                     |
| team_id               | INT     | Unique identifier for the team                      |
| player_id             | INT     | Unique identifier for the player                    |
| avg_runs              | DOUBLE  | Average number of runs scored by the player         |
| avg_hits              | DOUBLE  | Average number of hits by the player                |
| avg_homeRuns          | DOUBLE  | Average number of home runs by the player           |
| avg_rbi               | DOUBLE  | Average runs batted in by the player                |
| avg_strikeOuts        | DOUBLE  | Average number of strikeouts by the player          |
| avg_baseOnBalls       | DOUBLE  | Average number of bases on balls (walks) by the player|
| avg_gamesPlayed       | DOUBLE  | Average number of games played by the player        |
| month                 | INT     | Month when the season was played                    |
| player_type           | STRING  | Type of player (home or away)                       |

### mlb_db.cumulative_team_season_totals
The `cumulative_team_season_totals` table stores cumulative current season totals for each team.

| Column                | Type    | Description                                         |
| ----------------------| ------- | --------------------------------------------------- |
| season                | INT     | The season year                                     |
| team_id               | INT     | Unique identifier for the team                      |
| total_runs            | INT     | Total number of runs scored by the team             |
| total_hits            | INT     | Total number of hits by the team                    |
| total_homeRuns        | INT     | Total number of home runs by the team               |
| total_rbi             | INT     | Total runs batted in by the team                    |
| total_strikeOuts      | INT     | Total number of strikeouts by the team              |
| total_baseOnBalls     | INT     | Total number of bases on balls (walks) by the team  |
| total_gamesPlayed     | INT     | Total number of games played by the team            |
| month                 | INT     | Month when the season was played                    |
| team_type             | STRING  | Type of team (home or away)                         |

### mlb_db.cumulative_players_season_totals
The `cumulative_players_season_totals` table stores cumulative current season totals for each player.

| Column                | Type    | Description                                         |
| ----------------------| ------- | --------------------------------------------------- |
| season                | INT     | The season year                                     |
| team_id               | INT     | Unique identifier for the team                      |
| player_id             | INT     | Unique identifier for the player                    |
| total_runs            | INT     | Total number of runs scored by the player           |
| total_hits            | INT     | Total number of hits by the player                  |
| total_homeRuns        | INT     | Total number of home runs by the player             |
| total_rbi             | INT     | Total runs batted in by the player                  |
| total_strikeOuts      | INT     | Total number of strikeouts by the player            |
| total_baseOnBalls     | INT     | Total number of bases on balls (walks) by the player|
| total_gamesPlayed     | INT     | Total number of games played by the player          |
| month                 | INT     | Month when the season was played                    |
| player_type           | STRING  | Type of player (home or away)                       |

### mlb_db.cumulative_team_season_averages
The `cumulative_team_season_averages` table stores cumulative current season averages for each team.

| Column                | Type    | Description                                         |
| ----------------------| ------- | --------------------------------------------------- |
| season                | INT     | The season year                                     |
| team_id               | INT     | Unique identifier for the team                      |
| avg_runs              | DOUBLE  | Average number of runs scored by the team           |
| avg_hits              | DOUBLE  | Average number of hits by the team                  |
| avg_homeRuns          | DOUBLE  | Average number of home runs by the team             |
| avg_rbi               | DOUBLE  | Average runs batted in by the team                  |
| avg_strikeOuts        | DOUBLE  | Average number of strikeouts by the team            |
| avg_baseOnBalls       | DOUBLE  | Average number of bases on balls (walks) by the team|
| avg_gamesPlayed       | DOUBLE  | Average number of games played by the team          |
| month                 | INT     | Month when the season was played                    |
| team_type             | STRING  | Type of team (home or away)                         |

### mlb_db.cumulative_players_season_averages
The `cumulative_players_season_averages` table stores cumulative current season averages for each player.

| Column                | Type    | Description                                         |
| ----------------------| ------- | --------------------------------------------------- |
| season                | INT     | The season year                                     |
| team_id               | INT     | Unique identifier for the team                      |
| player_id             | INT     | Unique identifier for the player                    |
| avg_runs              | DOUBLE  | Average number of runs scored by the player         |
| avg_hits              | DOUBLE  | Average number of hits by the player                |
| avg_homeRuns          | DOUBLE  | Average number of home runs by the player           |
| avg_rbi               | DOUBLE  | Average runs batted in by the player                |
| avg_strikeOuts        | DOUBLE  | Average number of strikeouts by the player          |
| avg_baseOnBalls       | DOUBLE  | Average number of bases on balls (walks) by the player|
| avg_gamesPlayed       | DOUBLE  | Average number of games played by the player        |
| month                 | INT     | Month when the season was played                    |
| player_type           | STRING  | Type of player (home or away)                       |



### future_teamStats
The future_teamStats table stores the future team statistics.

| Column                | Type    | Comment                      |
| --------------------- | ------- | ---------------------------- |
| game_id               | STRING  | Game ID                      |
| game_date             | DATE    | Game Date                    |
| team_id               | INT     | Team ID                      |
| team_name             | STRING  | Team Name                    |
| flyOuts               | INT     | Fly Outs                     |
| groundOuts            | INT     | Ground Outs                  |
| airOuts               | INT     | Air Outs                     |
| runs                  | INT     | Runs                         |
| doubles               | INT     | Doubles                      |
| triples               | INT     | Triples                      |
| homeRuns              | INT     | Home Runs                    |
| strikeOuts            | INT     | Strike Outs                  |
| baseOnBalls           | INT     | Base on Balls                |
| intentionalWalks      | INT     | Intentional Walks            |
| hits                  | INT     | Hits                         |
| hitByPitch            | INT     | Hit by Pitch                 |
| avg                   | DOUBLE  | Batting Average              |
| atBats                | INT     | At Bats                      |
| obp                   | DOUBLE  | On-base Percentage           |
| slg                   | DOUBLE  | Slugging Percentage          |
| ops                   | DOUBLE  | On-base Plus Slugging        |
| caughtStealing        | INT     | Caught Stealing              |
| stolenBases           | INT     | Stolen Bases                 |
| stolenBasePercentage  | DOUBLE  | Stolen Base Percentage       |
| groundIntoDoublePlay  | INT     | Ground into Double Play      |
| groundIntoTriplePlay  | INT     | Ground into Triple Play      |
| plateAppearances      | INT     | Plate Appearances            |
| totalBases            | INT     | Total Bases                  |
| rbi                   | INT     | Runs Batted In               |
| leftOnBase            | INT     | Left on Base                 |
| sacBunts              | INT     | Sacrifice Bunts              |
| sacFlies              | INT     | Sacrifice Flies              |
| catchersInterference  | INT     | Catchers Interference        |
| pickoffs              | INT     | Pickoffs                     |
| atBatsPerHomeRun      | DOUBLE  | At Bats per Home Run         |
| popOuts               | INT     | Pop Outs                     |
| lineOuts              | INT     | Line Outs                    |
| team_type             | STRING  | Team Type (home/away)        |
| season                | INT     | Season Year                  |
| month                 | INT     | Month                        |

The `future_teamStats` table is overwritten with new data by selecting future home and away team stats from 'dim_future_teamStats' table, 
combining them, and then writing the combined data to the `future_teamStats` table in Iceberg with `mode("overwrite")`. 
The data selected is for dates greater than or equal to the current date plus one day:

SELECT ...

FROM spark_catalog.default.dim_future_teamStats

WHERE officialDate >= date_add(current_date(), 1)


### future_playersStats
The future_playersStats table stores the future player statistics.

| Column                | Type    | Comment                      |
| --------------------- | ------- | ---------------------------- |
| game_id               | STRING  | Game ID                      |
| player_id             | INT     | Player ID                    |
| player_name           | STRING  | Player Name                  |
| team_id               | INT     | Team ID                      |
| team_name             | STRING  | Team Name                    |
| batting_order         | INT     | Batting Order                |
| batting_summary       | STRING  | Batting Summary              |
| batting_gamesPlayed   | INT     | Batting Games Played         |
| batting_flyOuts       | INT     | Batting Fly Outs             |
| batting_groundOuts    | INT     | Batting Ground Outs          |
| batting_airOuts       | INT     | Batting Air Outs             |
| batting_runs          | INT     | Batting Runs                 |
| batting_doubles       | INT     | Batting Doubles              |
| batting_triples       | INT     | Batting Triples              |
| batting_homeRuns      | INT     | Batting Home Runs            |
| batting_strikeOuts    | INT     | Batting Strike Outs          |
| batting_baseOnBalls   | INT     | Batting Base on Balls        |
| batting_intentionalWalks | INT  | Batting Intentional Walks    |
| batting_hits          | INT     | Batting Hits                 |
| batting_hitByPitch    | INT     | Batting Hit by Pitch         |
| batting_avg           | DOUBLE  | Batting Average              |
| batting_atBats        | INT     | Batting At Bats              |
| batting_obp           | DOUBLE  | Batting On-base Percentage   |
| batting_slg           | DOUBLE  | Batting Slugging Percentage  |
| batting_ops           | DOUBLE  | Batting On-base Plus Slugging|
| batting_caughtStealing| INT     | Batting Caught Stealing      |
| batting_stolenBases   | INT     | Batting Stolen Bases         |
| batting_stolenBasePercentage | DOUBLE | Batting Stolen Base Percentage |
| batting_groundIntoDoublePlay | INT | Batting Ground into Double Play |
| batting_groundIntoTriplePlay | INT | Batting Ground into Triple Play |
| batting_plateAppearances | INT | Batting Plate Appearances    |
| batting_totalBases    | INT     | Batting Total Bases          |
| batting_rbi           | INT     | Batting Runs Batted In       |
| batting_leftOnBase    | INT     | Batting Left on Base         |
| batting_sacBunts      | INT     | Batting Sacrifice Bunts      |
| batting_sacFlies      | INT     | Batting Sacrifice Flies      |
| batting_catchersInterference | INT | Batting Catchers Interference |
| batting_pickoffs      | INT     | Batting Pickoffs             |
| batting_atBatsPerHomeRun | DOUBLE | Batting At Bats per Home Run |
| batting_popOuts       | INT     | Batting Pop Outs             |
| batting_lineOuts      | INT     | Batting Line Outs            |
| fielding_gamesStarted | INT     | Fielding Games Started       |
| fielding_caughtStealing | INT  | Fielding Caught Stealing     |
| fielding_stolenBases  | INT     | Fielding Stolen Bases        |
| fielding_stolenBasePercentage | DOUBLE | Fielding Stolen Base Percentage |
| fielding_assists      | INT     | Fielding Assists             |
| fielding_putOuts      | INT     | Fielding Put Outs            |
| fielding_errors       | INT     | Fielding Errors              |
| fielding_chances      | INT     | Fielding Chances             |
| fielding_fielding     | DOUBLE  | Fielding Percentage          |
| fielding_passedBall   | INT     | Fielding Passed Ball         |
| fielding_pickoffs     | INT     | Fielding Pickoffs            |
| player_type           | STRING  | Player Type (home/away)      |
| season                | INT     | Season Year                  |
| month                 | INT     | Month                        |

The future_players table is overwritten with new data by selecting future home and away player stats from 'dim_future_playersStats' table, 
combining them, and then writing the combined data to the future_players table in Iceberg with mode("overwrite"). 
The data selected is for dates greater than or equal to the current date plus one day:

SELECT ...

FROM spark_catalog.default.dim_future_playersStats

WHERE officialDate >= date_add(current_date(), 1)
